From 3dd895cdd05c9d351e1dd6729e00bb3c9bd8833a Mon Sep 17 00:00:00 2001
From: "Dougal J. Sutherland" <dougal@gmail.com>
Date: Wed, 3 Jan 2018 14:16:29 +0000
Subject: [PATCH] switch to setuptools instead of numpy.distutils

Backport of https://github.com/scikit-garden/scikit-garden/pull/49
---
 setup.py                            | 55 ++++++++++++++++++++++++-------------
 skgarden/mondrian/ensemble/setup.py | 17 ------------
 skgarden/mondrian/setup.py          | 32 ---------------------
 skgarden/mondrian/tree/setup.py     | 37 -------------------------
 skgarden/quantile/setup.py          | 17 ------------
 skgarden/setup.py                   | 19 -------------
 6 files changed, 36 insertions(+), 141 deletions(-)
 delete mode 100644 skgarden/mondrian/ensemble/setup.py
 delete mode 100644 skgarden/mondrian/setup.py
 delete mode 100644 skgarden/mondrian/tree/setup.py
 delete mode 100644 skgarden/quantile/setup.py
 delete mode 100644 skgarden/setup.py

diff --git a/setup.py b/setup.py
index 9e44711..4d3aa59 100644
--- a/setup.py
+++ b/setup.py
@@ -1,11 +1,12 @@
 #! /usr/bin/env python
 
+from distutils.version import LooseVersion
 import sys
 import os
-import setuptools
-import numpy
-from numpy.distutils.core import setup
-from setuptools import find_packages
+
+import numpy as np
+from setuptools import Extension, find_packages, setup
+
 
 DISTNAME = 'scikit-garden'
 DESCRIPTION = "A garden of scikit-learn compatible trees"
@@ -15,26 +16,41 @@
 LICENSE = 'new BSD'
 VERSION = '0.1.3'
 
+CYTHON_MIN_VERSION = '0.23'
 
-def configuration(parent_package='', top_path=None):
-    if os.path.exists('MANIFEST'):
-        os.remove('MANIFEST')
 
-    from numpy.distutils.misc_util import Configuration
-    config = Configuration(None, parent_package, top_path)
-    config.add_subpackage('skgarden')
+message = ('Please install cython with a version >= {0} in order '
+           'to build a scikit-garden development version.').format(
+           CYTHON_MIN_VERSION)
 
-    return config
+try:
+    import Cython
+    if LooseVersion(Cython.__version__) < CYTHON_MIN_VERSION:
+        message += ' Your version of Cython was {0}.'.format(Cython.__version__)
+        raise ValueError(message)
+    from Cython.Build import cythonize
+except ImportError as exc:
+    exc.args += (message,)
+    raise
 
-if __name__ == "__main__":
+libraries = []
+if os.name == 'posix':
+    libraries.append('m')
 
-    old_path = os.getcwd()
-    local_path = os.path.dirname(os.path.abspath(sys.argv[0]))
+extensions = []
+for name in ['_tree', '_splitter', '_criterion', '_utils']:
+    extensions.append(Extension(
+        'skgarden.mondrian.tree.{0}'.format(name),
+        sources=['skgarden/mondrian/tree/{0}.pyx'.format(name)],
+        include_dirs=[np.get_include()],
+        libraries=libraries,
+        extra_compile_args=['-O3'],
+    ))
+extensions = cythonize(extensions)
 
-    os.chdir(local_path)
-    sys.path.insert(0, local_path)
-    setup(configuration=configuration,
-          name=DISTNAME,
+
+if __name__ == "__main__":
+    setup(name=DISTNAME,
           maintainer=MAINTAINER,
           maintainer_email=MAINTAINER_EMAIL,
           packages=find_packages(),
@@ -58,4 +74,5 @@ def configuration(parent_package='', top_path=None):
               'Operating System :: MacOS'
             ],
           install_requires=["numpy", "scipy", "scikit-learn>=0.18", "cython"],
-          setup_requires=["cython"])
+          setup_requires=["cython"],
+          ext_modules=extensions)
diff --git a/skgarden/mondrian/ensemble/setup.py b/skgarden/mondrian/ensemble/setup.py
deleted file mode 100644
index c55d054..0000000
--- a/skgarden/mondrian/ensemble/setup.py
+++ /dev/null
@@ -1,17 +0,0 @@
-import os
-
-import numpy
-from numpy.distutils.misc_util import Configuration
-
-
-def configuration(parent_package="", top_path=None):
-    config = Configuration("ensemble", parent_package, top_path)
-    libraries = []
-    if os.name == 'posix':
-        libraries.append('m')
-    return config
-
-
-if __name__ == "__main__":
-    from numpy.distutils.core import setup
-    setup(**configuration(top_path="").todict())
diff --git a/skgarden/mondrian/setup.py b/skgarden/mondrian/setup.py
deleted file mode 100644
index 5be66ac..0000000
--- a/skgarden/mondrian/setup.py
+++ /dev/null
@@ -1,32 +0,0 @@
-from distutils.version import LooseVersion
-
-CYTHON_MIN_VERSION = '0.23'
-
-def configuration(parent_package='', top_path=None):
-    from numpy.distutils.misc_util import Configuration
-
-    config = Configuration('mondrian', parent_package, top_path)
-    config.add_subpackage('tree')
-    config.add_subpackage('ensemble')
-
-    message = ('Please install cython with a version >= {0} in order '
-               'to build a scikit-learn development version.').format(
-               CYTHON_MIN_VERSION)
-    try:
-        import Cython
-        if LooseVersion(Cython.__version__) < CYTHON_MIN_VERSION:
-            message += ' Your version of Cython was {0}.'.format(
-                Cython.__version__)
-            raise ValueError(message)
-        from Cython.Build import cythonize
-    except ImportError as exc:
-        exc.args += (message,)
-        raise
-    config.ext_modules = cythonize(config.ext_modules)
-
-    return config
-
-
-if __name__ == '__main__':
-    from numpy.distutils.core import setup
-    setup(**configuration(top_path='').todict())
diff --git a/skgarden/mondrian/tree/setup.py b/skgarden/mondrian/tree/setup.py
deleted file mode 100644
index 55a580b..0000000
--- a/skgarden/mondrian/tree/setup.py
+++ /dev/null
@@ -1,37 +0,0 @@
-import os
-
-import numpy
-from numpy.distutils.misc_util import Configuration
-
-
-def configuration(parent_package="", top_path=None):
-    config = Configuration("tree", parent_package, top_path)
-    libraries = []
-    if os.name == 'posix':
-        libraries.append('m')
-    config.add_extension("_tree",
-                         sources=["_tree.pyx"],
-                         include_dirs=[numpy.get_include()],
-                         libraries=libraries,
-                         extra_compile_args=["-O3"])
-    config.add_extension("_splitter",
-                         sources=["_splitter.pyx"],
-                         include_dirs=[numpy.get_include()],
-                         libraries=libraries,
-                         extra_compile_args=["-O3"])
-    config.add_extension("_criterion",
-                         sources=["_criterion.pyx"],
-                         include_dirs=[numpy.get_include()],
-                         libraries=libraries,
-                         extra_compile_args=["-O3"])
-    config.add_extension("_utils",
-                         sources=["_utils.pyx"],
-                         include_dirs=[numpy.get_include()],
-                         libraries=libraries,
-                         extra_compile_args=["-O3"])
-
-    return config
-
-if __name__ == "__main__":
-    from numpy.distutils.core import setup
-    setup(**configuration(top_path="").todict())
diff --git a/skgarden/quantile/setup.py b/skgarden/quantile/setup.py
deleted file mode 100644
index 828c00c..0000000
--- a/skgarden/quantile/setup.py
+++ /dev/null
@@ -1,17 +0,0 @@
-import os
-
-import numpy
-from numpy.distutils.misc_util import Configuration
-
-
-def configuration(parent_package="", top_path=None):
-    config = Configuration("quantile", parent_package, top_path)
-    libraries = []
-    if os.name == 'posix':
-        libraries.append('m')
-    return config
-
-
-if __name__ == "__main__":
-    from numpy.distutils.core import setup
-    setup(**configuration(top_path="").todict())
diff --git a/skgarden/setup.py b/skgarden/setup.py
deleted file mode 100644
index 691798f..0000000
--- a/skgarden/setup.py
+++ /dev/null
@@ -1,19 +0,0 @@
-import os
-
-import numpy
-from numpy.distutils.misc_util import Configuration
-
-
-def configuration(parent_package="", top_path=None):
-    config = Configuration("skgarden", parent_package, top_path)
-    config.add_subpackage("mondrian")
-    config.add_subpackage("quantile")
-    libraries = []
-    if os.name == 'posix':
-        libraries.append('m')
-    return config
-
-
-if __name__ == "__main__":
-    from numpy.distutils.core import setup
-    setup(**configuration(top_path="").todict())
-- 
2.7.4

